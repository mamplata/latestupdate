import Dialog from"../helpers/Dialog.js";import{addDownload,getYearRange}from"../../../js/fetch.js";let riceProductions=[];class RiceProduction{constructor(e,o,t,r,n,c,a,i,s){this.recordId=e;this.barangay=o;this.cropName=t;this.areaPlanted=r;this.monthHarvested=n;this.volumeProduction=c;this.averageYield=a;this.season=i;this.year=s}async addRiceProduction(e){function o(o,t){const r=[];for(let e=0;e<o.length;e+=t){r.push(o.slice(e,e+t))}return r}const t=20;const r=e.length;const n=o(e,t);let c=0;const a=(e,o)=>{$("#progressMessage").text(`Uploading ${e}-${o}/${r}`)};$("#loader").show();$("body").addClass("no-scroll");for(const[s,d]of n.entries()){const l=c+1;const u=l+d.length-1;a(l,u);try{await $.ajax({url:"/api/riceProductions-batch",method:"POST",data:{riceProductionData:d,_token:$('meta[name="csrf-token"]').attr("content")}});c+=d.length}catch(i){console.error(`Error sending batch ${s+1}:`,i.responseText)}}$("#loader").hide();$("body").removeClass("no-scroll");toastr.success("File uploaded successfully!","Success",{timeOut:5e3,positionClass:"toast-top-center",toastClass:"toast-success-custom"});getRiceProduction()}updateRiceProduction(o){const e=riceProductions.find(e=>e.riceProductionId===o.riceProductionId);if(e&&e.riceProductionId!==o.riceProductionId){alert("riceProduction ID already exists");return}riceProductions=riceProductions.map(e=>e.recordId===o.recordId?{...e,...o}:e);fetch(`/api/riceProductions/${o.riceProductionId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(e=>e.json()).then(e=>{})["catch"](e=>{console.error("Error:",e)});getRiceProduction()}removeRiceProduction(e){$.ajax({url:"/api/riceProductionsByRecords",method:"DELETE",data:{riceProductionData:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){},error:function(e){console.error(e.responseText)}});getRiceProduction()}}async function getRiceProduction(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});return new Promise((o,r)=>{$.ajax({url:"/api/riceProductions",method:"GET",success:function(e){riceProductions=e;o(riceProductions)},error:function(e,o,t){console.error("Error fetching riceProductions:",t);r(t)}})})}function initializeMethodsRiceProduction(){function a(e){const o=e.toLowerCase();const t=riceProductions.filter(e=>{return Object.values(e).some(e=>e.toString().toLowerCase().includes(o))});return t}var i=5;var s=1;async function o(e=null){await new Promise(e=>setTimeout(e,1e3));$("#riceProductionTableBody").empty();var o=(s-1)*i;var t=o+i;const r=e?a(e):riceProductions;if(r.length>0){for(var n=o;n<t;n++){if(n>=r.length){break}var c=r[n];$("#riceProductionTableBody").append(`
                    <tr data-index=${c.riceProductionId}>
                        <td>${c.barangay}</td>
                        <td>${c.cropName}</td>
                        <td>${c.areaPlanted}</td>
                        <td>${c.monthHarvested}</td>
                        <td>${c.volumeProduction.toFixed(2)}</td>
                        <td>â‚±${c.averageYield.toFixed(2)}</td>
                        <td>${c.season}</td>
                        <td>${c.year}</td>
                    </tr>
        `)}}else{$("#riceProductionTableBody").append(`
        <tr>
          <td colspan="12">No results found!</td>
        </tr>
      `)}$("#riceProductionTable").trigger("update")}$("#search").on("input",function(){let e=$("#search").val();o(e)});$("#prevBtn").click(function(){if(s>1){s--;o($("#search").val())}});$("#nextBtn").click(function(){var e=Math.ceil(a($("#search").val()).length/i);if(s<e){s++;o($("#search").val())}});$(document).ready(function(){$(".download-btn").click(function(){Dialog.downloadDialog().then(e=>{t(e,riceProductions)})["catch"](e=>{console.error("Error:",e)})})});let r="";async function e(){r=await getYearRange()}e();function t(e,o){const t=`riceProduction Data ${r}`;if(e==="csv"){c(t,o)}else if(e==="xlsx"){l(t,o)}else if(e==="pdf"){u(t,o)}}function d(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}function n(e){if(typeof e==="string"&&(e.includes(",")||e.includes("\n")||e.includes('"'))){e='"'+e.replace(/"/g,'""')+'"'}return e}function c(e,o){const t={barangay:"Barangay",cropName:"Commodity",areaPlanted:"Area Planted (ha)",monthHarvested:"Month Harvested",volumeProduction:"Volume of Production (ha)",averageYield:"Average Yield (ha)",season:"Season",year:"Year"};const r=["barangay","cropName","areaPlanted","monthHarvested","volumeProduction","averageYield","season","year"];const n=r.map(e=>t[e]);function c(e){if(e===undefined||e===null)return"";if(typeof e==="string"&&(e.includes(",")||e.includes('"')||e.includes("\n"))){e=`"${e.replace(/"/g,'""')}"`}return e}const a=[n.join(","),...o.map(t=>r.map(e=>{let o=t[e]!==undefined?t[e]:"";return c(o)}).join(","))].join("\n");const i=new Blob([a],{type:"text/csv"});const s=URL.createObjectURL(i);const d=document.createElement("a");d.href=s;d.download=e;document.body.appendChild(d);d.click();document.body.removeChild(d);URL.revokeObjectURL(s);addDownload(e,"CSV")}function l(n,e){const r={barangay:"Barangay",cropName:"Commodity",areaPlanted:"Area Planted (ha)",monthHarvested:"Month Harvested",volumeProduction:"Volume of Production (ha)",averageYield:"Average Yield (ha)",season:"Season",year:"Year"};const c=["barangay","cropName","areaPlanted","monthHarvested","volumeProduction","averageYield","season","year"];const o=c.map(e=>r[e]);const t=e.map(t=>{return c.reduce((e,o)=>{e[r[o]]=t[o];return e},{})});const a=new ExcelJS.Workbook;const i=a.addWorksheet(n);i.addRow(o);t.forEach(o=>{i.addRow(c.map(e=>o[r[e]]))});const s={font:{name:"Calibri",size:12,bold:true,color:{argb:"FFFFFFFF"}},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"203764"}},alignment:{horizontal:"center",vertical:"middle"},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const d={font:{name:"Calibri",size:11},alignment:{horizontal:"center",vertical:"middle",wrapText:true},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};i.getRow(1).eachCell(e=>{e.style=s});i.eachRow({includeEmpty:true},(e,o)=>{if(o>1){e.eachCell(e=>{e.style=d})}});i.columns=o.map(e=>({width:Math.max(e.length,10)+5}));a.xlsx.writeBuffer().then(e=>{const o=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const t=URL.createObjectURL(o);const r=document.createElement("a");r.href=t;r.download=n;document.body.appendChild(r);r.click();document.body.removeChild(r);URL.revokeObjectURL(t)});addDownload(n,"XLSX")}function u(e,o){const{jsPDF:t}=window.jspdf;const r=new t("landscape");const n=[...new Set(o.flatMap(Object.keys))];const c=n.filter(e=>!e.toLowerCase().includes("id"));const a=c.slice(0,c.length-2);const i=a.map(d);const s=e=>{if(typeof e==="number"){return e.toFixed(2)}return e};r.autoTable({head:[i],body:o.map(t=>a.map(e=>{let o=t[e];return s(o)})),theme:"striped"});r.save(e);addDownload(e,"PDF")}function d(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}async function g(){try{await getRiceProduction();o()}catch(e){console.error("Failed to initialize riceProduction display:",e)}}g()}async function processRiceProductionData(e,r,o,t,n){var c=e.SheetNames[0];var a=e.Sheets[c];var i=getKeyBySubstring(r,"Volume of Production");var s=XLSX.utils.decode_range(a["!ref"]);let d=[];for(var l=s.s.r+1;l<=s.e.r;l++){var u=i.charAt(0)+(l+1);var g=a[u]?a[u].v:"";if(!isNumeric(g)){continue}var h={};Object.keys(r).forEach(function(e){var o=r[e].charAt(0)+(l+1);var t=a[o]?a[o].v:"";h[e]=t});var m=new RiceProduction(o,getKeyBySubstring(h,"Barangay"),getKeyBySubstring(h,"Commodity"),getKeyBySubstring(h,"Area Planted"),getKeyBySubstring(h,"Month Harvested"),getKeyBySubstring(h,"Volume of Production"),getKeyBySubstring(h,"Average Yield"),t,n);d.push(m)}var f=riceProductions.find(e=>e.recordId===d[0].recordId);if(f){await d[0].removeRiceProduction(d)}d[0].addRiceProduction(d);return riceProductions}function isNumeric(e){return!isNaN(parseFloat(e))&&isFinite(e)}function getKeyBySubstring(o,e){const t=e.trim().toLowerCase();for(let e in o){if(e.trim().toLowerCase().includes(t)){return o[e]}}return null}export{RiceProduction,getRiceProduction,riceProductions,initializeMethodsRiceProduction,processRiceProductionData};