import Dialog from"../helpers/Dialog.js";import{getCrop}from"../../../js/fetch.js";let cropVarieties=[];class CropVariety{constructor(e,t,r,a,o,i,s,l,c,d){this.varietyId=e;this.cropId=t;this.varietyName=r;this.color=a;this.size=o;this.flavor=i;this.growthConditions=s;this.pestDiseaseResistance=l;this.recommendedPractices=c;this.cropImg=d}async createCropVariety(t){const e=cropVarieties.find(e=>e.varietyName===t.varietyName&&e.cropId===t.cropId);if(e){alert("Crop variety with the same name already exists");return}$("#progressMessage").text("Uploading...");$("#loader").show();$("body").addClass("no-scroll");try{await $.ajax({url:"/api/crop-varieties",type:"POST",contentType:"application/json",data:JSON.stringify(t)});toastr.success("Crop variety added successfully!","Success",{timeOut:5e3,positionClass:"toast-top-center",toastClass:"toast-success-custom"})}catch(r){console.error("Error:",r);toastr.error("Failed to add crop variety. Please try again.","Error",{timeOut:5e3,positionClass:"toast-top-center",toastClass:"toast-error-custom"})}finally{$("#loader").hide();$("body").removeClass("no-scroll");$("#progressMessage").text("")}}updateCropVariety(t){const e=cropVarieties.find(e=>e.varietyName===t.varietyName&&e.varietyId!==t.varietyId);if(e){alert("Crop variety with the same name already exists");return}cropVarieties=cropVarieties.map(e=>e.varietyId===t.varietyId?{...e,...t}:e);fetch(`/api/crop-varieties/${t.varietyId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{})["catch"](e=>{console.error("Error:",e)})}removeCropVariety(t){fetch(`/api/crop-varieties/${t}`,{method:"DELETE",headers:{"Content-Type":"application/json"}}).then(e=>{if(e.status===204){cropVarieties=cropVarieties.filter(e=>e.varietyId!==t);}else if(e.status===404){console.error(`Crop variety with ID ${t} not found.`)}else{console.error(`Failed to delete crop variety with ID ${t}.`)}})["catch"](e=>{console.error("Error:",e)})}}function getCropVarieties(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$.ajax({url:"/api/crop-varieties",method:"GET",success:function(e){let t=e;cropVarieties=t;},error:function(e,t,r){console.error("Error fetching crops:",r)}})}getCropVarieties();function searchCropVariety(t){const e=cropVarieties.filter(e=>e.varietyName.toLowerCase().includes(t.toLowerCase()));return e}function initializeMethodsCropVariety(){var m=null;var d=5;var n=1;var u=false;var r=null;async function h(e=null){await new Promise(e=>setTimeout(e,1e3));$("#cropVarietyTableBody").empty();const t=await getCrop();const r=t.reduce((e,t)=>{e[t.cropId]=t.cropName;return e},{});var a=(n-1)*d;var o=a+d;if(e){const l=searchCropVariety(e);if(l.length>0){l.forEach(e=>{const t=r[e.cropId]||"Unknown Crop";$("#cropVarietyTableBody").append(`
                        <tr data-index="${e.varietyId}" class="text-center">
                            <td style="display: none;">${e.varietyId}</td>
                            <td><img src="${e.cropImg}" alt="${e.varietyName}" class="img-thumbnail" width="50" height="50"></td>
                            <td>${e.varietyName}</td>
                            <td>${t}</td> <!-- Display the associated cropName -->
                            <td class="crop-cell" title="${e.color}">${e.color}</td>
                            <td class="crop-cell" title="${e.size}">${e.size}</td>
                            <td class="crop-cell" title="${e.flavor}">${e.flavor}</td>
                            <td class="crop-cell" title="${e.growthConditions}">${e.growthConditions}</td>
                            <td class="crop-cell" title="${e.pestDiseaseResistance}">${e.pestDiseaseResistance}</td>
                            <td class="crop-cell" title="${e.recommendedPractices}">${e.recommendedPractices}</td>
                        </tr>
                    `)})}else{$("#cropVarietyTableBody").append(`
                    <tr>
                        <td colspan="10">Crop variety not found!</td>
                    </tr>
                `)}}else{for(var i=a;i<o;i++){if(i>=cropVarieties.length){break}var s=cropVarieties[i];const c=r[s.cropId]||"Unknown Crop";$("#cropVarietyTableBody").append(`
                    <tr data-index="${s.varietyId}" class="text-center">
                        <td style="display: none;">${s.varietyId}</td>
                        <td><img src="${s.cropImg}" alt="${s.varietyName}" class="img-thumbnail" width="50" height="50"></td>
                        <td>${s.varietyName}</td>
                        <td>${c}</td> <!-- Display the associated cropName -->
                        <td class="crop-cell" title="${s.color}">${s.color}</td>
                        <td class="crop-cell" title="${s.size}">${s.size}</td>
                        <td class="crop-cell" title="${s.flavor}">${s.flavor}</td>
                        <td class="crop-cell" title="${s.growthConditions}">${s.growthConditions}</td>
                        <td class="crop-cell" title="${s.pestDiseaseResistance}">${s.pestDiseaseResistance}</td>
                        <td class="crop-cell" title="${s.recommendedPractices}">${s.recommendedPractices}</td>
                    </tr>
                `)}}}h();$("#search").on("input",function(){let e=$("#search").val();h(e)});$("#prevBtn").click(function(){if(n>1){n--;h()}});$("#nextBtn").click(function(){var e=Math.ceil(crops.length/d);if(n<e){n++;h()}});let a="";$("#submitBtn").click(function(e){e.preventDefault();var o=Number($("#varietyId").val());var i=Number($("#cropId").val());var s=$("#varietyName").val();var l=$("#color").val();var c=$("#size").val();var d=$("#flavor").val();var n=$("#growthConditions").val();var p=$("#pestDiseaseResistance").val();var y=$("#recommendedPractices").val();var t=document.getElementById("cropImg").files[0];var v=null;if(t){var r=new FileReader;r.onloadend=function(){var a=new Image;a.src=r.result;a.onload=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.width=a.width;e.height=a.height;t.drawImage(a,0,0);v=e.toDataURL("image/webp",.8);let r=new CropVariety(o,i,s,l,c,d,n,p,y,v);if(m!==null&&u){r.updateCropVariety(r);m=null;$("#submitBtn").text("Add Crop Variety");$("#cancelBtn").hide();u=false}else{r.createCropVariety(r)}getCropVarieties();h();$("#cropVarietyForm")[0].reset();$("#cropVarietyTableBody tr").removeClass("selected-row")}};r.readAsDataURL(t)}else{if(m!==null&&u){let e=new CropVariety(o,i,s,l,c,d,n,p,y,a);e.updateCropVariety(e);m=null;$("#submitBtn").text("Add Crop Variety");$("#cancelBtn").hide();u=false}else{let e=new CropVariety(o,i,s,l,c,d,n,p,y,null);e.createCropVariety(e)}getCropVarieties();h();a="";$("#cropVarietyForm")[0].reset();$("#lblCropImg").val("Upload Image:");$("#cropVarietyTableBody tr").removeClass("selected-row");$("#editBtn").prop("disabled",true);$("#deleteBtn").prop("disabled",true)}});function t(){$("#editBtn").prop("disabled",true);$("#deleteBtn").prop("disabled",true);m=null;$("#cropVarietyTableBody tr").removeClass("selected-row")}$("#editBtn").click(async function(){const e=await Dialog.confirmDialog("Confirm Edit","Are you sure you want to edit this crop variety's details?");if(e.operation===1){$("#editModal").modal("hide");$("#cancelBtn").show();$("#varietyId").val(r.varietyId);$("#cropId").val(r.cropId);$("#varietyName").val(r.varietyName);$("#color").val(r.color);$("#size").val(r.size);$("#flavor").val(r.flavor);$("#growthConditions").val(r.growthConditions);$("#pestDiseaseResistance").val(r.pestDiseaseResistance);$("#recommendedPractices").val(r.recommendedPractices);a=r.cropImg;$("#lblCropImg").text("Upload New Image (Optional):");u=true;$("#submitBtn").text("Update Variety")}$("#cropVarietyTableBody tr").removeClass("selected-row");$("#editBtn").prop("disabled",true);$("#deleteBtn").prop("disabled",true)});$("#cancelEdit").click(function(){t();$("#cropVarietyTableBody tr").removeClass("selected-row");$("#editBtn").prop("disabled",true);$("#deleteBtn").prop("disabled",true)});$("#cancelBtn").click(function(){m=null;$("#cropVarietyForm")[0].reset();$("#submitBtn").text("Add Crop Variety");$("#cancelBtn").hide();$("#cropVarietyTableBody tr").removeClass("selected-row");$("#editBtn").prop("disabled",true);$("#deleteBtn").prop("disabled",true)});$("#deleteBtn").click(async function(){const e=await Dialog.confirmDialog("Confirm Deletion","Are you sure you want to delete this crop variety?");if(e.operation===1){let e=new CropVariety;e.removeCropVariety(r.varietyId);getCropVarieties();h();t()}else{$("#cropVarietyTableBody tr").removeClass("selected-row");$("#editBtn").prop("disabled",true);$("#deleteBtn").prop("disabled",true)}});$("#cropVarietyTableBody").on("click","tr",function(){var e=$(this);var t=e.data("index");r=cropVarieties.find(e=>e.varietyId===t);m=t;if(m!==null){$("#cropVarietyTableBody tr").removeClass("selected-row");$("#cropVarietyTableBody tr").filter(function(){return parseInt($(this).find("td:eq(0)").text(),10)===m}).addClass("selected-row");$("#editBtn").prop("disabled",false);$("#deleteBtn").prop("disabled",false)}else{$("#cropVarietyTableBody tr").removeClass("selected-row")}})}export{CropVariety,getCropVarieties,searchCropVariety,initializeMethodsCropVariety,cropVarieties};