import Dialog from"../helpers/Dialog.js";import{addDownload,getYearRange}from"../../../js/fetch.js";let prices=[];class Price{constructor(e,t,r,o,n){this.recordId=e;this.cropName=t;this.price=r;this.season=o;this.monthYear=n}async addPrice(e){function t(t,r){const o=[];for(let e=0;e<t.length;e+=r){o.push(t.slice(e,e+r))}return o}const r=20;const o=e.length;const n=t(e,r);let c=0;const a=(e,t)=>{$("#progressMessage").text(`Uploading ${e}-${t}/${o}`)};$("#loader").show();$("body").addClass("no-scroll");for(const[i,l]of n.entries()){const d=c+1;const p=d+l.length-1;a(d,p);try{await $.ajax({url:"/api/prices-batch",method:"POST",data:{priceData:l,_token:$('meta[name="csrf-token"]').attr("content")}});c+=l.length}catch(s){console.error(`Error sending batch ${i+1}:`,s.responseText)}}$("#loader").hide();$("body").removeClass("no-scroll");toastr.success("Prices uploaded successfully!","Success",{timeOut:5e3,positionClass:"toast-top-center",toastClass:"toast-success-custom"});getPrices()}updatePrice(t){const e=prices.find(e=>e.recordId===t.recordId);if(e&&e.recordId!==t.recordId){alert("Price ID already exists");return}prices=prices.map(e=>e.recordId===t.recordId?{...e,...t}:e);fetch(`/api/prices/${t.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{})["catch"](e=>{console.error("Error:",e)});getPrices()}removePrice(e){$.ajax({url:"/api/pricesByRecords",method:"DELETE",data:{priceData:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){},error:function(e){console.error(e.responseText)}});getPrices()}}function getPrices(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$.ajax({url:"/api/prices",method:"GET",success:function(e){prices=e;},error:function(e,t,r){console.error("Error fetching prices:",r)}})}function initializeMethodsPrice(){function a(e){const t=e.toLowerCase();const r=prices.filter(e=>{return Object.values(e).some(e=>e.toString().toLowerCase().includes(t))});return r}var s=5;var i=1;async function t(e=null){await new Promise(e=>setTimeout(e,1e3));$("#priceTableBody").empty();var t=(i-1)*s;var r=t+s;const o=e?a(e):prices;if(o.length>0){for(var n=t;n<r;n++){if(n>=o.length){break}var c=o[n];$("#priceTableBody").append(`
                    <tr data-index=${c.priceId}>
                        <td>${c.cropName}</td>
                        <td>₱${c.price}</td>
                        <td>${c.season}</td>
                        <td>${c.monthYear}</td>
                    </tr>
        `)}}else{$("#priceTableBody").append(`
        <tr>
          <td colspan="4">No results found!</td>
        </tr>
      `)}$("#priceTable").trigger("update")}$("#search").on("input",function(){let e=$("#search").val();t(e)});$("#prevBtn").click(function(){if(i>1){i--;t($("#search").val())}});$("#nextBtn").click(function(){var e=Math.ceil(a($("#search").val()).length/s);if(i<e){i++;t($("#search").val())}});$(document).ready(function(){$(".download-btn").click(function(){Dialog.downloadDialog().then(e=>{r(e,prices)})["catch"](e=>{console.error("Error:",e)})})});let o="";async function e(){o=await getYearRange()}e();function r(e,t){const r=`Prices Data ${o}`;if(e==="csv"){n(r,t)}else if(e==="xlsx"){c(r,t)}else if(e==="pdf"){l(r,t)}}function n(e,t){const r={cropName:"Commodity",price:"Farm Gate Price",season:"Season",monthYear:"Month Year"};const o=["cropName","price","season","monthYear"];const n=o.map(e=>r[e]);function c(e){if(e===undefined||e===null)return"";if(typeof e==="string"&&(e.includes(",")||e.includes('"')||e.includes("\n"))){e=`"${e.replace(/"/g,'""')}"`}return e}const a=[n.join(","),...t.map(r=>o.map(e=>{let t=r[e]!==undefined?r[e]:"";if(e==="price"){return t?`₱${parseFloat(t).toFixed(2)}`:""}return c(t)}).join(","))].join("\n");const s=new Blob([a],{type:"text/csv"});const i=URL.createObjectURL(s);const l=document.createElement("a");l.href=i;l.download=e;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(i);addDownload(e,"CSV")}function c(n,e){const o={cropName:"Commodity",price:"Farm Gate Price",season:"Season",monthYear:"Month Year"};const c=["cropName","price","season","monthYear"];const t=c.map(e=>o[e]);const r=e.map(t=>{const r={};c.forEach(e=>{r[o[e]]=t[e]});return r});const a=new ExcelJS.Workbook;const s=a.addWorksheet(n);s.addRow(t);r.forEach(r=>{s.addRow(c.map(e=>{const t=r[o[e]];if(e==="price"){return t?`₱${parseFloat(t).toFixed(2)}`:""}return t}))});const i={font:{name:"Calibri",size:12,bold:true,color:{argb:"FFFFFFFF"}},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"203764"}},alignment:{horizontal:"center",vertical:"middle"},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const l={font:{name:"Calibri",size:11},alignment:{horizontal:"center",vertical:"middle",wrapText:true},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const d=s.getRow(1);d.eachCell({includeEmpty:true},e=>{e.style=i});d.height=20;s.eachRow({includeEmpty:true},(e,t)=>{if(t>1){e.eachCell({includeEmpty:true},e=>{e.style=l})}});s.columns=t.map(e=>({width:Math.max(e.length,10)+5}));a.xlsx.writeBuffer().then(function(e){const t=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const r=URL.createObjectURL(t);const o=document.createElement("a");o.href=r;o.download=n;o.click();URL.revokeObjectURL(r)});addDownload(n,"XLSX")}function l(e,t){const{jsPDF:r}=window.jspdf;const o=new r("landscape");const n=[...new Set(t.flatMap(Object.keys))];const c=n.filter(e=>!e.toLowerCase().includes("id"));const a=c.slice(0,c.length-2);const s=a.map(d);const i=e=>{if(typeof e==="number"){return e.toFixed(2)}return e};o.autoTable({head:[s],body:t.map(r=>a.map(e=>{let t=r[e];return i(t)})),theme:"striped"});o.save(e);addDownload(e,"PDF")}function d(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}getPrices();t()}function isNumeric(e){if(!isNaN(e)&&!isNaN(parseFloat(e))){return true}const t=/^\d+-\d+$/;if(t.test(e)){const[r,o]=e.split("-").map(Number);if(!isNaN(r)&&!isNaN(o)&&r<=o){return true}}return false}async function processPriceData(e,o,t,r,n){var c=e.SheetNames[0];var a=e.Sheets[c];var s=getKeyBySubstring(o,"Farm Gate Price");var i=XLSX.utils.decode_range(a["!ref"]);let l=[];for(var d=i.s.r+1;d<=i.e.r;d++){var p=s.charAt(0)+(d+1);var u=a[p]?a[p].v:"";if(!isNumeric(u)){continue}var f={};Object.keys(o).forEach(function(e){var t=o[e].charAt(0)+(d+1);var r=a[t]?a[t].v:"";f[e]=r});var m=new Price(t,getKeyBySubstring(f,"Commodity"),String(getKeyBySubstring(f,"Farm Gate Price")),r,n);l.push(m)}var h=prices.find(e=>e.recordId===l[0].recordId);if(h){await l[0].removePrice(l)}l[0].addPrice(l);return prices}function getKeyBySubstring(t,e){const r=e.trim().toLowerCase();for(let e in t){if(e.trim().toLowerCase().includes(r)){return t[e]}}return null}export{Price,getPrices,prices,initializeMethodsPrice,processPriceData};