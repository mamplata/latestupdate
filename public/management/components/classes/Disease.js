import Dialog from"../helpers/Dialog.js";import{addDownload,getYearRange}from"../../../js/fetch.js";let diseases=[];class Disease{constructor(e,t,s,a,o,n,r,c){this.recordId=e;this.barangay=t;this.cropName=s;this.diseaseName=a;this.totalPlanted=o;this.totalAffected=n;this.season=r;this.monthYear=c}async addDisease(e){function t(t,s){const a=[];for(let e=0;e<t.length;e+=s){a.push(t.slice(e,e+s))}return a}const s=20;const a=e.length;const o=t(e,s);let n=0;const r=(e,t)=>{$("#progressMessage").text(`Uploading ${e}-${t}/${a}`)};$("#loader").show();$("body").addClass("no-scroll");for(const[i,l]of o.entries()){const d=n+1;const f=d+l.length-1;r(d,f);try{await $.ajax({url:"/api/diseases-batch",method:"POST",data:{diseaseData:l,_token:$('meta[name="csrf-token"]').attr("content")}});n+=l.length}catch(c){console.error(`Error sending batch ${i+1}:`,c.responseText)}}$("#loader").hide();$("body").removeClass("no-scroll");toastr.success("Diseases uploaded successfully!","Success",{timeOut:5e3,positionClass:"toast-top-center",toastClass:"toast-success-custom"});getDiseases()}updateDisease(t){const e=diseases.find(e=>e.recordId===t.recordId);if(e&&e.recordId!==t.recordId){alert("Disease record ID already exists");return}diseases=diseases.map(e=>e.recordId===t.recordId?{...e,...t}:e);fetch(`/api/diseases/${t.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{})["catch"](e=>{console.error("Error:",e)});getDiseases()}removeDisease(e){$.ajax({url:"/api/diseasesByRecords",method:"DELETE",data:{diseaseData:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){},error:function(e){console.error(e.responseText)}});getDiseases()}}function getDiseases(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$.ajax({url:"/api/diseases",method:"GET",success:function(e){diseases=e;},error:function(e,t,s){console.error("Error fetching diseases:",s)}})}function initializeMethodsDisease(){function r(e){const t=e.toLowerCase();const s=diseases.filter(e=>{return Object.values(e).some(e=>e.toString().toLowerCase().includes(t))});return s}var c=5;var i=1;async function t(e=null){await new Promise(e=>setTimeout(e,1e3));$("#diseaseTableBody").empty();var t=(i-1)*c;var s=t+c;const a=e?r(e):diseases;if(a.length>0){for(var o=t;o<s;o++){if(o>=a.length){break}var n=a[o];$("#diseaseTableBody").append(`
            <tr data-index=${n.diseaseId}>
              <td>${n.barangay}</td>
              <td>${n.cropName}</td>
              <td>${n.diseaseName}</td>
              <td>${n.totalPlanted}</td>
              <td>${n.totalAffected}</td>
              <td>${n.season}</td>
              <td>${n.monthYear}</td>
            </tr>
          `)}}else{$("#diseaseTableBody").append(`
          <tr>
            <td colspan="7">No results found!</td>
          </tr>
        `)}$("#diseaseTable").trigger("update")}$("#search").on("input",function(){let e=$("#search").val();t(e)});$("#prevBtn").click(function(){if(i>1){i--;t($("#search").val())}});$("#nextBtn").click(function(){var e=Math.ceil(r($("#search").val()).length/c);if(i<e){i++;t($("#search").val())}});$(document).ready(function(){$(".download-btn").click(function(){Dialog.downloadDialog().then(e=>{s(e,diseases)})["catch"](e=>{console.error("Error:",e)})})});let a="";async function e(){a=await getYearRange()}e();function s(e,t){const s=`Diseases Data ${a}`;if(e==="csv"){o(s,t)}else if(e==="xlsx"){n(s,t)}else if(e==="pdf"){l(s,t)}}function o(e,t){const s={barangay:"Barangay",cropName:"Crops Planted",diseaseName:"Disease Observed",totalPlanted:"Total no. of Trees/Plants Planted",totalAffected:"Total no. of Trees/Plants Affected/Damaged",season:"Season"};const a=["barangay","cropName","diseaseName","totalPlanted","totalAffected","season"];const o=a.map(e=>s[e]);function n(e){if(e===undefined||e===null)return"";if(typeof e==="string"&&(e.includes(",")||e.includes('"')||e.includes("\n"))){e=`"${e.replace(/"/g,'""')}"`}return e}const r=[o.join(","),...t.map(s=>a.map(e=>{const t=s[e]!==undefined?s[e]:"";return n(t)}).join(","))].join("\n");const c=new Blob([r],{type:"text/csv"});const i=URL.createObjectURL(c);const l=document.createElement("a");l.href=i;l.download=e;document.body.appendChild(l);l.click();document.body.removeChild(l);URL.revokeObjectURL(i);addDownload(e,"CSV")}function n(o,e){const a={barangay:"Barangay",cropName:"Crops Planted",diseaseName:"Disease Observed",totalPlanted:"Total no. of Trees/Plants Planted",totalAffected:"Total no. of Trees/Plants Affected/Damaged",season:"Season"};const n=["barangay","cropName","diseaseName","totalPlanted","totalAffected","season"];const t=n.map(e=>a[e]);const s=e.map(t=>{const s={};n.forEach(e=>{s[a[e]]=t[e]});return s});const r=new ExcelJS.Workbook;const c=r.addWorksheet(o);c.addRow(t);s.forEach(s=>{c.addRow(n.map(e=>{const t=s[a[e]];return t}))});const i={font:{name:"Calibri",size:12,bold:true,color:{argb:"FFFFFFFF"}},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"203764"}},alignment:{horizontal:"center",vertical:"middle"},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const l={font:{name:"Calibri",size:11},alignment:{horizontal:"center",vertical:"middle",wrapText:true},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const d=c.getRow(1);d.eachCell({includeEmpty:true},e=>{e.style=i});d.height=20;c.eachRow({includeEmpty:true},(e,t)=>{if(t>1){e.eachCell({includeEmpty:true},e=>{e.style=l})}});c.columns=t.map(e=>({width:Math.max(e.length,10)+5}));r.xlsx.writeBuffer().then(function(e){const t=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const s=URL.createObjectURL(t);const a=document.createElement("a");a.href=s;a.download=o;a.click();URL.revokeObjectURL(s)});addDownload(o,"XLSX")}function l(e,t){const{jsPDF:s}=window.jspdf;const a=new s("landscape");const o=[...new Set(t.flatMap(Object.keys))];const n=o.filter(e=>!e.toLowerCase().includes("id"));const r=n.slice(0,n.length-2);const c=r.map(d);const i=e=>{if(typeof e==="number"){return e.toFixed(2)}return e};a.autoTable({head:[c],body:t.map(s=>r.map(e=>{let t=s[e];return i(t)})),theme:"striped"});a.save(e);addDownload(e,"PDF")}function d(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}getDiseases();t()}async function processDiseaseData(e,a,t,s,o){var n=e.SheetNames[0];var r=e.Sheets[n];var c=getKeyBySubstring(a,"Disease Observed");var i=XLSX.utils.decode_range(r["!ref"]);let l=[];for(var d=i.s.r+5;d<=i.e.r;d++){var f=c.charAt(0)+(d+1);var u=r[f]?r[f].v:"";if(u===""||u==="None"){continue}var h=XLSX.utils.decode_cell(c+"1").c;var g=XLSX.utils.encode_col(h+1)+(d+1);var p=XLSX.utils.encode_col(h+2)+(d+1);var m={};Object.keys(a).forEach(function(e){var t=a[e].charAt(0)+(d+1);var s=r[t]?r[t].v:"";m[e]=s});m["TotalPlanted"]=r[g]?r[g].v:0;m["TotalAffected"]=r[p]?r[p].v:0;var y=new Disease(t,getKeyBySubstring(m,"Farm Location"),getKeyBySubstring(m,"Crops Planted"),getKeyBySubstring(m,"Disease Observed"),m["TotalPlanted"],m["TotalAffected"],s,o);l.push(y)}if(l.length!==0){var b=diseases.find(e=>e.recordId===l[0].recordId);if(b){await l[0].removeDisease(l)}l[0].addDisease(l)}return diseases}function getKeyBySubstring(t,e){const s=e.trim().toLowerCase();for(let e in t){if(e.trim().toLowerCase().includes(s)){return t[e]}}return null}export{Disease,getDiseases,diseases,initializeMethodsDisease,processDiseaseData};