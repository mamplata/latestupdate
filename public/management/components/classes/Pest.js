import Dialog from"../helpers/Dialog.js";import{addDownload,getYearRange}from"../../../js/fetch.js";let pests=[];class Pest{constructor(e,t,o,s,n,a,r,c){this.recordId=e;this.barangay=t;this.cropName=o;this.pestName=s;this.totalPlanted=n;this.totalAffected=a;this.season=r;this.monthYear=c}async addPest(e){function t(t,o){const s=[];for(let e=0;e<t.length;e+=o){s.push(t.slice(e,e+o))}return s}const o=20;const s=e.length;const n=t(e,o);let a=0;const r=(e,t)=>{$("#progressMessage").text(`Uploading ${e}-${t}/${s}`)};$("#loader").show();$("body").addClass("no-scroll");for(const[l,d]of n.entries()){const i=a+1;const p=i+d.length-1;r(i,p);try{await $.ajax({url:"/api/pests-batch",method:"POST",data:{pestData:d,_token:$('meta[name="csrf-token"]').attr("content")}});a+=d.length}catch(c){console.error(`Error sending batch ${l+1}:`,c.responseText)}}$("#loader").hide();$("body").removeClass("no-scroll");toastr.success("Pests uploaded successfully!","Success",{timeOut:5e3,positionClass:"toast-top-center",toastClass:"toast-success-custom"});getPests()}updatePest(t){const e=pests.find(e=>e.recordId===t.recordId);if(e&&e.recordId!==t.recordId){alert("Pest record ID already exists");return}pests=pests.map(e=>e.recordId===t.recordId?{...e,...t}:e);fetch(`/api/pests/${t.recordId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>e.json()).then(e=>{})["catch"](e=>{console.error("Error:",e)});getPests()}removePest(e){$.ajax({url:"/api/pestsByRecords",method:"DELETE",data:{pestData:e,_token:$('meta[name="csrf-token"]').attr("content")},success:function(e){},error:function(e){console.error(e.responseText)}});getPests()}}function getPests(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});$.ajax({url:"/api/pests",method:"GET",success:function(e){pests=e;},error:function(e,t,o){console.error("Error fetching pests:",o)}})}function initializeMethodsPest(){function r(e){const t=e.toLowerCase();const o=pests.filter(e=>{return Object.values(e).some(e=>e.toString().toLowerCase().includes(t))});return o}var c=5;var l=1;async function t(e=null){await new Promise(e=>setTimeout(e,1e3));$("#pestTableBody").empty();var t=(l-1)*c;var o=t+c;const s=e?r(e):pests;if(s.length>0){for(var n=t;n<o;n++){if(n>=s.length){break}var a=s[n];$("#pestTableBody").append(`
            <tr data-index=${a.pestId}>
              <td>${a.barangay}</td>
              <td>${a.cropName}</td>
              <td>${a.pestName}</td>
              <td>${a.totalPlanted}</td>
              <td>${a.totalAffected}</td>
              <td>${a.season}</td>
              <td>${a.monthYear}</td>
            </tr>
          `)}}else{$("#pestTableBody").append(`
          <tr>
            <td colspan="7">No results found!</td>
          </tr>
        `)}$("#pestTable").trigger("update")}$("#search").on("input",function(){let e=$("#search").val();t(e)});$("#prevBtn").click(function(){if(l>1){l--;t($("#search").val())}});$("#nextBtn").click(function(){var e=Math.ceil(r($("#search").val()).length/c);if(l<e){l++;t($("#search").val())}});$(document).ready(function(){$(".download-btn").click(function(){Dialog.downloadDialog().then(e=>{o(e,pests)})["catch"](e=>{console.error("Error:",e)})})});let s="";async function e(){s=await getYearRange()}e();function o(e,t){const o=`Pests Data ${s}`;if(e==="csv"){n(o,t)}else if(e==="xlsx"){a(o,t)}else if(e==="pdf"){d(o,t)}}function n(e,t){const o={barangay:"Barangay",cropName:"Crops Planted",pestName:"Pest Observed",totalPlanted:"Total no. of Trees/Plants Planted",totalAffected:"Total no. of Trees/Plants Affected/Damaged",season:"Season"};const s=["barangay","cropName","pestName","totalPlanted","totalAffected","season"];const n=s.map(e=>o[e]);function a(e){if(e===undefined||e===null)return"";if(typeof e==="string"&&(e.includes(",")||e.includes('"')||e.includes("\n"))){e=`"${e.replace(/"/g,'""')}"`}return e}const r=[n.join(","),...t.map(o=>s.map(e=>{const t=o[e]!==undefined?o[e]:"";return a(t)}).join(","))].join("\n");const c=new Blob([r],{type:"text/csv"});const l=URL.createObjectURL(c);const d=document.createElement("a");d.href=l;d.download=e;document.body.appendChild(d);d.click();document.body.removeChild(d);URL.revokeObjectURL(l);addDownload(e,"CSV")}function a(n,e){const s={barangay:"Barangay",cropName:"Crops Planted",pestName:"Pest Observed",totalPlanted:"Total no. of Trees/Plants Planted",totalAffected:"Total no. of Trees/Plants Affected/Damaged",season:"Season"};const a=["barangay","cropName","totalPlanted","totalAffected","pestName","season"];const t=a.map(e=>s[e]);const o=e.map(t=>{const o={};a.forEach(e=>{o[s[e]]=t[e]});return o});const r=new ExcelJS.Workbook;const c=r.addWorksheet(n);c.addRow(t);o.forEach(o=>{c.addRow(a.map(e=>{const t=o[s[e]];return t}))});const l={font:{name:"Calibri",size:12,bold:true,color:{argb:"FFFFFFFF"}},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"203764"}},alignment:{horizontal:"center",vertical:"middle"},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const d={font:{name:"Calibri",size:11},alignment:{horizontal:"center",vertical:"middle",wrapText:true},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const i=c.getRow(1);i.eachCell({includeEmpty:true},e=>{e.style=l});i.height=20;c.eachRow({includeEmpty:true},(e,t)=>{if(t>1){e.eachCell({includeEmpty:true},e=>{e.style=d})}});c.columns=t.map(e=>({width:Math.max(e.length,10)+5}));r.xlsx.writeBuffer().then(function(e){const t=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const o=URL.createObjectURL(t);const s=document.createElement("a");s.href=o;s.download=n;s.click();URL.revokeObjectURL(o)});addDownload(n,"XLSX")}function d(e,t){const{jsPDF:o}=window.jspdf;const s=new o("landscape");const n=[...new Set(t.flatMap(Object.keys))];const a=n.filter(e=>!e.toLowerCase().includes("id"));const r=a.slice(0,a.length-2);const c=r.map(i);const l=e=>{if(typeof e==="number"){return e.toFixed(2)}return e};s.autoTable({head:[c],body:t.map(o=>r.map(e=>{let t=o[e];return l(t)})),theme:"striped"});s.save(e);addDownload(e,"PDF")}function i(e){return e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}getPests();t()}async function processPestData(e,s,t,o,n){var a=e.SheetNames[0];var r=e.Sheets[a];var c=getKeyBySubstring(s,"Pest Observed");var l=XLSX.utils.decode_range(r["!ref"]);let d=[];for(var i=l.s.r+1;i<=l.e.r;i++){var p=c.charAt(0)+(i+1);var f=r[p]?r[p].v:"";if(f===""||f==="None"){continue}var u=XLSX.utils.decode_cell(c+"1").c;var h=XLSX.utils.encode_col(u+1)+(i+1);var g=XLSX.utils.encode_col(u+2)+(i+1);var m={};Object.keys(s).forEach(function(e){var t=s[e].charAt(0)+(i+1);var o=r[t]?r[t].v:"";m[e]=o});m["TotalPlanted"]=r[h]?r[h].v:0;m["TotalAffected"]=r[g]?r[g].v:0;var y=new Pest(t,getKeyBySubstring(m,"Farm Location"),getKeyBySubstring(m,"Crops Planted"),getKeyBySubstring(m,"Pest Observed"),m["TotalPlanted"]||0,m["TotalAffected"]||0,o,n);d.push(y)}if(d.length!==0){var b=pests.find(e=>e.recordId===d[0].recordId);if(b){await d[0].removePest(d)}d[0].addPest(d.slice(2))}return pests}function getKeyBySubstring(t,e){const o=e.trim().toLowerCase();for(let e in t){if(e.trim().toLowerCase().includes(o)){return t[e]}}return null}export{Pest,getPests,pests,initializeMethodsPest,processPestData};