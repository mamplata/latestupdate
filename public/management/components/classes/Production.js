import Dialog from"../helpers/Dialog.js";import{addDownload,getYearRange}from"../../../js/fetch.js";let productions=[];class Production{constructor(t,o,e,n,r,a,c,i,s,d,l,u,p){this.recordId=t;this.barangay=o;this.cropName=e;this.variety=n;this.areaPlanted=r;this.monthPlanted=a;this.monthHarvested=c;this.volumeProduction=i;this.productionCost=s;this.volumeSold=l;this.price=d;this.season=u;this.monthYear=p}async addProduction(t){function o(o,e){const n=[];for(let t=0;t<o.length;t+=e){n.push(o.slice(t,t+e))}return n}const e=20;const n=t.length;const r=o(t,e);let a=0;const c=(t,o)=>{$("#progressMessage").text(`Uploading ${t}-${o}/${n}`)};$("#loader").show();$("body").addClass("no-scroll");for(const[s,d]of r.entries()){const l=a+1;const u=l+d.length-1;c(l,u);try{await $.ajax({url:"/api/productions-batch",method:"POST",data:{productionData:d,_token:$('meta[name="csrf-token"]').attr("content")}});a+=d.length}catch(i){console.error(`Error sending batch ${s+1}:`,i.responseText)}}$("#loader").hide();$("body").removeClass("no-scroll");toastr.success("File uploaded successfully!","Success",{timeOut:5e3,positionClass:"toast-top-center",toastClass:"toast-success-custom"});getProduction()}updateProduction(o){const t=productions.find(t=>t.productionId===o.productionId);if(t&&t.productionId!==o.productionId){alert("Production ID already exists");return}productions=productions.map(t=>t.recordId===o.recordId?{...t,...o}:t);fetch(`/api/productions/${o.productionId}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(t=>t.json()).then(t=>{})["catch"](t=>{console.error("Error:",t)});getProduction()}removeProduction(t){$.ajax({url:"/api/productionsByRecords",method:"DELETE",data:{productionData:t,_token:$('meta[name="csrf-token"]').attr("content")},success:function(t){},error:function(t){console.error(t.responseText)}});getProduction()}}async function getProduction(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}});return new Promise((o,n)=>{$.ajax({url:"/api/productions",method:"GET",success:function(t){productions=t;o(productions)},error:function(t,o,e){console.error("Error fetching productions:",e);n(e)}})})}function initializeMethodsProduction(){function c(t){const o=t.toLowerCase();const e=productions.filter(t=>{return Object.values(t).some(t=>t.toString().toLowerCase().includes(o))});return e}var i=5;var s=1;async function o(t=null){await new Promise(t=>setTimeout(t,1e3));$("#productionTableBody").empty();var o=(s-1)*i;var e=o+i;const n=t?c(t):productions;if(n.length>0){for(var r=o;r<e;r++){if(r>=n.length){break}var a=n[r];$("#productionTableBody").append(`
          <tr data-index=${a.productionId}>
            <td>${a.barangay}</td>
            <td>${a.cropName}</td>
            <td>${a.variety}</td>
            <td>${a.areaPlanted.toFixed(2)}</td>
            <td>${a.monthPlanted}</td>
            <td>${a.monthHarvested}</td>
            <td>${a.volumeProduction.toFixed(2)}</td>
            <td>₱${a.productionCost.toFixed(2)}</td>
            <td>₱${a.price}</td>
            <td>${a.volumeSold.toFixed(2)}</td>
            <td>${a.season}</td>
            <td>${a.monthYear}</td>
          </tr>
        `)}}else{$("#productionTableBody").append(`
        <tr>
          <td colspan="12">No results found!</td>
        </tr>
      `)}$("#productionTable").trigger("update")}$("#search").on("input",function(){let t=$("#search").val();o(t)});$("#prevBtn").click(function(){if(s>1){s--;o($("#search").val())}});$("#nextBtn").click(function(){var t=Math.ceil(c($("#search").val()).length/i);if(s<t){s++;o($("#search").val())}});$(document).ready(function(){$(".download-btn").click(function(){Dialog.downloadDialog().then(t=>{e(t,productions)})["catch"](t=>{console.error("Error:",t)})})});let n="";async function t(){n=await getYearRange()}t();function e(t,o){const e=`Production Data ${n}`;if(t==="csv"){a(e,o)}else if(t==="xlsx"){l(e,o)}else if(t==="pdf"){u(e,o)}}function d(t){return t.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())}function r(t){if(typeof t==="string"&&(t.includes(",")||t.includes("\n")||t.includes('"'))){t='"'+t.replace(/"/g,'""')+'"'}return t}function a(t,o){const e={barangay:"Barangay",cropName:"Commodity",variety:"Variety",areaPlanted:"Area Planted (ha)",monthPlanted:"Month Planted",monthHarvested:"Month Harvested",volumeProduction:"Volume of Production (ha)",productionCost:"Cost of Production",price:"Farm Gate Price",volumeSold:"Volume Sold (ha)",season:"Season",monthYear:"Month Year"};const n=["barangay","cropName","variety","areaPlanted","monthPlanted","monthHarvested","volumeProduction","productionCost","price","volumeSold","season","monthYear"];const r=n.map(t=>e[t]);function a(t){if(t===undefined||t===null)return"";if(typeof t==="string"&&(t.includes(",")||t.includes('"')||t.includes("\n"))){t=`"${t.replace(/"/g,'""')}"`}return t}const c=[r.join(","),...o.map(e=>n.map(t=>{let o=e[t]!==undefined?e[t]:"";if(t==="productionCost"||t==="price"){return o?`₱${parseFloat(o).toFixed(2)}`:""}return a(o)}).join(","))].join("\n");const i=new Blob([c],{type:"text/csv"});const s=URL.createObjectURL(i);const d=document.createElement("a");d.href=s;d.download=t;document.body.appendChild(d);d.click();document.body.removeChild(d);URL.revokeObjectURL(s);addDownload(t,"CSV")}function l(r,t){const n={barangay:"Barangay",cropName:"Commodity",variety:"Variety",areaPlanted:"Area Planted (ha)",monthPlanted:"Month Planted",monthHarvested:"Month Harvested",volumeProduction:"Volume of Production (ha)",productionCost:"Cost of Production",price:"Farm Gate Price",volumeSold:"Volume Sold (ha)",season:"Season",monthYear:"Month Year"};const a=["barangay","cropName","variety","areaPlanted","monthPlanted","monthHarvested","volumeProduction","productionCost","price","volumeSold","season","monthYear"];const o=a.map(t=>n[t]);const e=t.map(o=>{const e={};a.forEach(t=>{e[n[t]]=o[t]});return e});const c=new ExcelJS.Workbook;const i=c.addWorksheet(r);i.addRow(o);e.forEach(e=>{i.addRow(a.map(t=>{const o=e[n[t]];if(t==="productionCost"||t==="price"){return o?`₱${parseFloat(o).toFixed(2)}`:""}return o}))});const s={font:{name:"Calibri",size:12,bold:true,color:{argb:"FFFFFFFF"}},fill:{type:"pattern",pattern:"solid",fgColor:{argb:"203764"}},alignment:{horizontal:"center",vertical:"middle"},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const d={font:{name:"Calibri",size:11},alignment:{horizontal:"center",vertical:"middle",wrapText:true},border:{top:{style:"thin",color:{argb:"FF000000"}},right:{style:"thin",color:{argb:"FF000000"}},bottom:{style:"thin",color:{argb:"FF000000"}},left:{style:"thin",color:{argb:"FF000000"}}}};const l=i.getRow(1);l.eachCell({includeEmpty:true},t=>{t.style=s});l.height=20;i.eachRow({includeEmpty:true},(t,o)=>{if(o>1){t.eachCell({includeEmpty:true},t=>{t.style=d})}});i.columns=o.map(t=>({width:Math.max(t.length,10)+5}));c.xlsx.writeBuffer().then(function(t){const o=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});const e=URL.createObjectURL(o);const n=document.createElement("a");n.href=e;n.download=r;n.click();URL.revokeObjectURL(e)});addDownload(r,"XLSX")}function u(t,o){const{jsPDF:e}=window.jspdf;const n=new e("landscape");const r=[...new Set(o.flatMap(Object.keys))];const a=r.filter(t=>!t.toLowerCase().includes("id"));const c=a.slice(0,a.length-2);const i=c.map(d);const s=t=>{if(typeof t==="number"){return t.toFixed(2)}return t};n.autoTable({head:[i],body:o.map(e=>c.map(t=>{let o=e[t];return s(o)})),theme:"striped"});n.save(t);addDownload(t,"PDF")}function d(t){return t.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/_/g," ").split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}async function p(){try{await getProduction();o()}catch(t){console.error("Failed to initialize production display:",t)}}p()}async function processProductionData(t,n,o,e,r){var a=t.SheetNames[0];var c=t.Sheets[a];var i=getKeyBySubstring(n,"Volume of Production");var s=XLSX.utils.decode_range(c["!ref"]);let d=[];for(var l=s.s.r+1;l<=s.e.r;l++){var u=i.charAt(0)+(l+1);var p=c[u]?c[u].v:"";if(!isNumeric(p)){continue}var h={};Object.keys(n).forEach(function(t){var o=n[t].charAt(0)+(l+1);var e=c[o]?c[o].v:"";h[t]=e});var m=new Production(o,getKeyBySubstring(h,"Barangay"),getKeyBySubstring(h,"Commodity"),getKeyBySubstring(h,"Variety"),getKeyBySubstring(h,"Area Planted"),getKeyBySubstring(h,"Month Planted"),getKeyBySubstring(h,"Month Harvested"),getKeyBySubstring(h,"Volume of Production"),getKeyBySubstring(h,"Cost of Production"),String(getKeyBySubstring(h,"Farm Gate Price")),getKeyBySubstring(h,"Volume Sold"),e,r);d.push(m)}var f=productions.find(t=>t.recordId===d[0].recordId);if(f){await d[0].removeProduction(d)}d[0].addProduction(d);return productions}function isNumeric(t){return!isNaN(parseFloat(t))&&isFinite(t)}function getKeyBySubstring(o,t){const e=t.trim().toLowerCase();for(let t in o){if(t.trim().toLowerCase().includes(e)){return o[t]}}return null}export{Production,getProduction,productions,initializeMethodsProduction,processProductionData};